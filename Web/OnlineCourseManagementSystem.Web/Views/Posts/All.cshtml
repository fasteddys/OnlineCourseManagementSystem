@using OnlineCourseManagementSystem.Web.ViewModels.Posts
@model AllPostsViewModel
@{
    this.ViewData["Title"] = "Forum";
}

<h1 class="text-center rounded" style="color: #ff6a00;background:#ffffff">Forum</h1>

<div class="d-flex" id="wrapper">

        <div class="border-right" style="background-color: lightslategrey" id="sidebar-wrapper">
            <div class="sidebar-heading text-white">
                Categories
            </div>
            <div class="list-group list-group-flush">
                <h4 class="text-white">
                    Courses Options(@this.Model.Courses.Count())
                </h4>
                <button type="button" class="btn btn-info" data-toggle="collapse" data-target="#allcourses">Courses</button>
                <div class="row">

                    <div class="col">
                        <div class="collapse" id="allcourses">
                            <div class="card card-body bg-dark">

                                @foreach (var course in this.Model.Courses)
                                {
                                    <a class="btn" style="background:#ffffff" asp-controller="Posts" asp-action="All" asp-route-id="1" asp-route-courseId ="@course.Id">
                                        <div style="color:#000000" class="row">
                                            <div class="col-md-8">
                                                @course.Name
                                                <span class="badge" style="background:#ff6a00; color:#ffffff">
                                                    @course.PostsCount
                                                </span>
                                            </div>
                                        </div>
                                    </a>

                                    <pre class="tab"></pre>
                                    <pre class="tab"></pre>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg navbar-light" style="background-color: lightslategrey">
                <button type="button" class="btn btn-info" id="menu-toggle">Toggle Menu</button>

                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </nav>
            <div class="container-fluid" >
                @if (this.TempData.ContainsKey("CreatedPost"))
                {
                    <div class="alert alert-success alert-dismissible">
                        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                        @this.TempData["CreatedPost"]
                    </div>
                }

            <pre class="tab"></pre>
            <pre class="tab"></pre>
                @if (!string.IsNullOrWhiteSpace(this.Model.Search))
                {
                    <h3 class="text-white">Search for "@this.Model.Search", page @this.Model.CurrentPage, results @this.Model.PostsCount</h3>
                }

                <form asp-controller="Posts" asp-action="All" asp-route-id="1" method="post">
                    <div class="input-group mb-4">
                        <input type="search" name="search" class="form-control" value="@this.Model.Search" placeholder="Enter title...." />
                        <div class="input-group-append">
                            <input type="submit" value="Search" class="btn btn-outline-secondary" />
                        </div>
                    </div>
                </form>

<pre class="tab"></pre>
<pre class="tab"></pre>

                @if (this.User.Identity.IsAuthenticated)
                {
                    <div>
                        <span>
                            <a class="btn" style="background:#ffffff; color:#ff6a00;" asp-controller="Posts" asp-action="Create">
                                Create Post
                            </a>
                        </span>
                    </div>
                }

<pre class="tab"></pre>
<pre class="tab"></pre>

                @if (!this.Model.Posts.Any())
                {
                    <h1 class="text-center text-white">No Posts</h1>
                }
                else
                {
                    <div class="container">
                        <div class="col justify-content-center">
                            @foreach (var post in this.Model.Posts)
                            {

                                <article class="row-cols-md-1 rounded" style="background:#d8d8d8">
                                    <div class="card-header">
                                        <a asp-controller="Posts" asp-action="SeePost" asp-route-id="@post.Id" class="text-dark">@post.Title</a>
                                        <p>
                                            <span>@post.AuthorName</span>
                                            <span>
                                                <img src="~/icons/calendar.png" />
                                                <span>@post.CreatedOn</span>
                                            </span>
                                        </p>
                                    </div>
                                    <div class="card-footer">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <form asp-controller="Posts" asp-action="Like" asp-route-id="@post.Id" asp-route-currentPage="@this.Model.CurrentPage" asp-route-courseId="@this.Model.CourseId" asp-route-search="@this.Model.Search" method="post">
                                                    @if (!this.User.Identity.IsAuthenticated)
                                                    {
                                                        <button type="button" class="btn btn-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top" data-bs-content="You need to be authenticated to rate this.">
                                                            <i class="fa fa-thumbs-up" style="font-size: 30px;"></i>
                                                        </button>
                                                    }
                                                    else
                                                    {

                                                        if (post.Likes.Any(x => x.CreatorName == this.User.Identity.Name))
                                                        {
                                                            <button id="likebtn" class=" btn btn-secondary" style="background:#137cdc">
                                                                <i class="fa fa-thumbs-up" style="font-size: 30px;"></i>
                                                            </button>
                                                        }
                                                        else
                                                        {
                                                            <button id="likebtn" class="btn btn-secondary">
                                                                <i class="fa fa-thumbs-up" style="font-size: 30px;"></i>
                                                            </button>
                                                        }

                                                    }
                                                    <span>Likes</span>
                                                    <span>@post.Likes.Count()</span>
                                                </form>
                                                <form asp-controller="Posts" asp-action="Dislike" asp-route-id="@post.Id" asp-route-currentPage="@this.Model.CurrentPage" asp-route-courseId="@this.Model.CourseId" asp-route-search="@this.Model.Search" method="post">
                                                    @if (!this.User.Identity.IsAuthenticated)
                                                    {
                                                        <button type="button" class="btn btn-secondary" data-bs-container="body" data-bs-toggle="popover" data-bs-placement="top" data-bs-content="You need to be authenticated to rate this.">
                                                            <i class="fa fa-thumbs-down" style="font-size: 30px;"></i>
                                                        </button>
                                                    }
                                                    else
                                                    {
                                                        if (post.Dislikes.Any(x => x.CreatorName == this.User.Identity.Name))
                                                        {
                                                            <button id="likebtn"  class="btn btn-secondary"style="background:#137cdc">
                                                                <i class="fa fa-thumbs-up" style="font-size: 30px;"></i>
                                                            </button>
                                                        }
                                                        else
                                                        {
                                                            <button id="dislikebtn" class="btn btn-secondary">
                                                                <i class="fa fa-thumbs-down " style="font-size: 30px;"></i>
                                                            </button>
                                                        }
                                                    }
                                                    <span>Dislikes</span>
                                                    <span>@post.Dislikes.Count()</span>
                                                </form>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="row">
                                                    <div class="col-md-5">
                                                        Last Active
                                                        @if (post.LastActive == null)
                                                        {
                                                            @post.CreatedOn
                                                        }
                                                        else
                                                        {
                                                            @post.CreatedOn
                                                        }
                                                    </div>
                                                    <div class="col-md-4">
                                                        @if (post.LastActive == null)
                                                        {
                                                            @post.AuthorName
                                                        }
                                                        else
                                                        {
                                                            @post.LastActive.Name
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <article>
                                            <div class="card-body">
                                                @if (this.User.Identity.Name == post.AuthorName)
                                                {
                                                    <span>
                                                        <a asp-controller="Posts" asp-action="Edit" asp-route-id="@post.Id" class="btn btn-info">
                                                            Edit
                                                        </a>
                                                    </span>
                                                    <pre class="tab"></pre>
                                                    <form asp-controller="Posts" asp-action="Delete" asp-route-id="@post.Id" method="post">
                                                        <span>
                                                            <button class="form-control" style="background:#ff0000; color:aliceblue">Delete</button>
                                                        </span>
                                                    </form>
                                                }
                                            </div>
                                        </article>
                                    </div>

                                </article>

                                <pre class="tab"></pre>
                            }
                        </div>
                    </div>
                }

                <nav aria-label="Page navigation example">
                    <ul class="pagination">
                        @if (this.Model.CurrentPage > 1)
                        {
                            <li class="page-item">

                                <a asp-controller="Posts" asp-action="All" asp-route-id="@this.Model.PreviousPage" asp-route-search="@this.Model.Search" class="page-link" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        }
                        @{
                            const int MorePagesToShow = 3;
                            var pagesToShow = new List<int>();
                            for (var i = 1; i <= MorePagesToShow; i++)
                            {
                                pagesToShow.Add(i);
                            }
                            for (var i = this.Model.CurrentPage - MorePagesToShow; i <= this.Model.CurrentPage + MorePagesToShow; i++)
                            {
                                if (i > 0)
                                {
                                    pagesToShow.Add(i);
                                }
                            }
                            for (var i = this.Model.PagesCount - MorePagesToShow + 1; i <= this.Model.PagesCount; i++)
                            {
                                if (i > 0)
                                {
                                    pagesToShow.Add(i);
                                }
                            }
                            pagesToShow = pagesToShow.Where(x => x <= this.Model.PagesCount).Distinct().OrderBy(x => x).ToList();
                        }
                        @{
                            @for (var i = 0; i < pagesToShow.Count; i++)
                            {
                                var className = string.Empty;
                                var pageNumber = pagesToShow[i];
                                if (pageNumber == this.Model.CurrentPage)
                                {
                                    className = "active";
                                }
                                if (i > 0 && pageNumber - 1 != pagesToShow[i - 1])
                                {
                                    <li class="page-item @className"><a class="page-link" asp-controller="Posts" asp-action="All" asp-route-id="@(pagesToShow[i - 1] + 1)" asp-route-search="@this.Model.Search">...</a></li>
                                }
                                <li class="page-item @className"><a class="page-link" asp-controller="Posts" asp-action="All" asp-route-id="@pageNumber" asp-route-search="@this.Model.Search">@pageNumber</a></li>
                            }
                        }
                        @if (this.Model.CurrentPage < this.Model.PagesCount)
                        {
                            <li class="page-item">
                                <a class="page-link" asp-controller="Posts" asp-action="All" asp-route-id="@this.Model.NextPage" asp-route-search="@this.Model.Search" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        </div>

    </div>





